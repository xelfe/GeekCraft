# GeekCraft Database Architecture

GeekCraft uses MongoDB as its persistent database backend for all game data. This document describes the database schema, configuration, and usage.

## Quick Navigation

- [Database Options](#database-options) - In-Memory vs MongoDB comparison
- [Standalone Server Deployment Guide](#standalone-server-deployment-guide) - **Complete setup guide for production**
- [MongoDB Schema](#mongodb-schema) - Collections and data structure
- [Troubleshooting](#troubleshooting-database-issues) - Common issues and solutions
- [Backup Strategy](#database-backup-strategy-for-production) - Production backup/restore

## Database Options

### 1. **In-Memory** (Default - Development/Testing)

**Best for:**
- Development and testing
- Quick experiments
- Automated testing

**Pros:**
- ✅ Fastest option
- ✅ No dependencies or setup
- ✅ Zero configuration
- ✅ Clean slate on every restart

**Cons:**
- ❌ All data lost on restart
- ❌ Not suitable for production

**Usage:**
```bash
# Default - uses In-Memory automatically
cargo run --release

# Or explicitly set
export GEEKCRAFT_DB_BACKEND=INMEMORY
cargo run --release
```

---

### 2. **MongoDB** (Recommended for Production MMO)

**Best for:**
- Production MMO servers
- Persistent game data storage
- Rich queries and analytics
- Multi-server deployments

**Pros:**
- ✅ Persistent storage (data survives restarts)
- ✅ Flexible document schema (JSON/BSON)
- ✅ Automatic session expiration (TTL indexes)
- ✅ Horizontal scaling (sharding and replication)
- ✅ Rich query capabilities
- ✅ Supports complex game data structures
- ✅ Industry standard for game backends

**Cons:**
- ❌ Requires MongoDB server installation
- ❌ More complex setup than In-Memory

**Installation:**

**Ubuntu/Debian:**
```bash
# Import MongoDB public GPG key
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | \
   sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor

# Add MongoDB repository
echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | \
   sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list

# Install MongoDB
sudo apt-get update
sudo apt-get install -y mongodb-org

# Start MongoDB
sudo systemctl start mongod
sudo systemctl enable mongod
```

**macOS:**
```bash
brew tap mongodb/brew
brew install mongodb-community@7.0
brew services start mongodb-community@7.0
```

**Docker:**
```bash
docker run -d \
  --name geekcraft-mongodb \
  -p 27017:27017 \
  -v mongodb_data:/data/db \
  mongo:7.0
```

**Usage:**
```bash
# Run with MongoDB
export GEEKCRAFT_DB_BACKEND=MONGODB
export MONGODB_URL=mongodb://localhost:27017/geekcraft
cargo run --release
```

---

## MongoDB Schema

GeekCraft uses the following MongoDB collections:

### Collections Overview

| Collection | Purpose | Indexes | TTL |
|------------|---------|---------|-----|
| `users` | User accounts and authentication | username (unique) | No |
| `sessions` | Active user sessions | token, expires_at (TTL) | Yes (auto-expire) |
| `user_code` | Player bot scripts | user_id, language | No |
| `maps` | Game maps and metadata | name, owner_id | No |
| `game_state` | Active game matches | match_id | No |
| `game_history` | Historical game data | match_id, created_at | Optional |
| `statistics` | Player stats and rankings | user_id, ranking | No |
| `counters` | Auto-incrementing ID sequences | _id | No |

---

### 1. Users Collection

Stores user accounts and authentication data.

**Collection:** `users`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "id": 1,                           // Auto-incrementing user ID
  "username": "player1",             // Unique username
  "password_hash": "$2b$12$...",     // bcrypt hashed password
  "created_at": 1699564800           // Unix timestamp
}
```

**Indexes:**
- `username` - Unique index for fast username lookups
- `id` - Auto-generated by MongoDB

**Example Document:**
```json
{
  "_id": ObjectId("65a1b2c3d4e5f6g7h8i9j0k1"),
  "id": 1,
  "username": "alice",
  "password_hash": "$2b$12$KIXv4Q9Z8mN5yR2jP1kL6uJ3hB7wF8xY0sT5nE9dA4gC6fM2lO8pQ",
  "created_at": 1699564800
}
```

---

### 2. Sessions Collection

Stores active user sessions with automatic expiration.

**Collection:** `sessions`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "token": "550e8400-e29b-41d4-a716-446655440000",  // UUID v4 token
  "user_id": 1,                                      // Reference to users.id
  "username": "player1",                             // Denormalized for performance
  "created_at": 1699564800,                          // Unix timestamp
  "expires_at": ISODate("2024-11-10T12:00:00Z")     // BSON DateTime for TTL
}
```

**Indexes:**
- `token` - For fast session lookups
- `expires_at` - TTL index (auto-deletes expired sessions)

**TTL Index:**
```javascript
db.sessions.createIndex(
  { "expires_at": 1 },
  { expireAfterSeconds: 0 }
)
```

**Example Document:**
```json
{
  "_id": ObjectId("65a1b2c3d4e5f6g7h8i9j0k2"),
  "token": "550e8400-e29b-41d4-a716-446655440000",
  "user_id": 1,
  "username": "alice",
  "created_at": 1699564800,
  "expires_at": ISODate("2024-11-10T12:00:00Z")
}
```

---

### 3. User Code Collection

Stores player bot scripts and code versions.

**Collection:** `user_code`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "user_id": 1,                      // Reference to users.id
  "username": "player1",             // Denormalized for convenience
  "language": "javascript",          // Programming language
  "code": "class Bot { ... }",      // Bot source code
  "version": 5,                      // Code version number
  "created_at": 1699564800,          // Unix timestamp
  "updated_at": 1699564900           // Unix timestamp
}
```

**Indexes:**
- `user_id` - For retrieving user's code
- `language` - For filtering by language (future multi-language support)

**Example Document:**
```json
{
  "_id": ObjectId("65a1b2c3d4e5f6g7h8i9j0k3"),
  "user_id": 1,
  "username": "alice",
  "language": "javascript",
  "code": "class MyBot {\n  onTick(gameState) {\n    console.log('Hello');\n  }\n}",
  "version": 5,
  "created_at": 1699564800,
  "updated_at": 1699564900
}
```

---

### 4. Maps Collection

Stores game maps, tiles, and metadata.

**Collection:** `maps`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "name": "Desert Arena",            // Map name
  "owner_id": 1,                     // Reference to users.id (map creator)
  "width": 100,                      // Map width in tiles
  "height": 100,                     // Map height in tiles
  "tiles": [                         // 2D array of tiles
    [
      { "type": "grass", "x": 0, "y": 0 },
      { "type": "rock", "x": 1, "y": 0, "resource": "minerals" }
    ]
  ],
  "metadata": {                      // Custom metadata
    "description": "A desert-themed PvP arena",
    "max_players": 4,
    "spawn_points": [[10, 10], [90, 90]]
  },
  "created_at": 1699564800,
  "updated_at": 1699565000
}
```

**Indexes:**
- `name` - For map name searches
- `owner_id` - For retrieving maps by creator

**Example Document:**
```json
{
  "_id": ObjectId("65a1b2c3d4e5f6g7h8i9j0k4"),
  "name": "Desert Arena",
  "owner_id": 1,
  "width": 100,
  "height": 100,
  "tiles": [],
  "metadata": {
    "description": "PvP arena",
    "max_players": 4
  },
  "created_at": 1699564800
}
```

---

### 5. Game State Collection

Stores active game matches and current state.

**Collection:** `game_state`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "match_id": "match-12345",         // Unique match identifier
  "map_id": ObjectId("..."),         // Reference to maps._id
  "players": [                       // Array of player states
    {
      "user_id": 1,
      "username": "alice",
      "units": [],
      "resources": { "minerals": 100, "gas": 50 }
    }
  ],
  "tick": 1000,                      // Current game tick
  "status": "active",                // Match status: active, paused, ended
  "created_at": 1699564800,
  "updated_at": 1699565000
}
```

**Indexes:**
- `match_id` - For fast match lookups
- `status` - For filtering active/ended matches

**Example Document:**
```json
{
  "_id": ObjectId("65a1b2c3d4e5f6g7h8i9j0k5"),
  "match_id": "match-12345",
  "map_id": ObjectId("65a1b2c3d4e5f6g7h8i9j0k4"),
  "players": [
    {
      "user_id": 1,
      "username": "alice",
      "units": [],
      "resources": { "minerals": 100 }
    }
  ],
  "tick": 1000,
  "status": "active",
  "created_at": 1699564800
}
```

---

### 6. Game History Collection

Stores historical game data for replays and statistics.

**Collection:** `game_history`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "match_id": "match-12345",         // Reference to completed match
  "winner_id": 1,                    // User ID of winner
  "players": [...],                  // Final player states
  "duration": 3600,                  // Match duration in seconds
  "final_tick": 5000,                // Final game tick
  "created_at": 1699564800,
  "ended_at": 1699568400
}
```

**Indexes:**
- `match_id` - For retrieving match history
- `created_at` - For chronological queries
- Optional TTL index for auto-deletion of old matches

---

### 7. Statistics Collection

Stores player statistics and rankings.

**Collection:** `statistics`

**Schema:**
```javascript
{
  "_id": ObjectId,
  "user_id": 1,                      // Reference to users.id
  "username": "alice",
  "wins": 10,
  "losses": 5,
  "draws": 2,
  "ranking": 1500,                   // ELO-style ranking
  "total_matches": 17,
  "updated_at": 1699565000
}
```

**Indexes:**
- `user_id` - Unique index for user stats
- `ranking` - For leaderboard queries

---

### 8. Counters Collection

Stores auto-incrementing ID sequences.

**Collection:** `counters`

**Schema:**
```javascript
{
  "_id": "user_id",                  // Counter name
  "value": 100                       // Current counter value
}
```

**Usage:**
```javascript
// Increment user_id counter
db.counters.findOneAndUpdate(
  { "_id": "user_id" },
  { "$inc": { "value": 1 } },
  { "upsert": true, "returnDocument": "after" }
)
```

---

## Comparison Table

| Feature | In-Memory | MongoDB |
|---------|-----------|---------|
| **Setup Complexity** | Easy | Medium |
| **External Dependencies** | None | MongoDB server |
| **Concurrent Users** | <1000 | >10,000 |
| **Persistence** | No | Yes |
| **Speed** | Fastest | Fast |
| **Horizontal Scaling** | No | Yes (sharding) |
| **Production Ready (MMO)** | ❌ No | ✅ Yes |
| **Rich Queries** | No | Yes |
| **Session Auto-Expiration** | Manual cleanup | Automatic (TTL) |
| **Game Data Storage** | Limited | Full support |
| **Analytics** | No | Yes |

---

## Recommendations by Deployment Type

### Development/Testing
```bash
# Use In-Memory (default) - simplest option
cargo run --release
```

### Production MMO Server
```bash
# Use MongoDB for persistent storage and scaling
export GEEKCRAFT_DB_BACKEND=MONGODB
export MONGODB_URL=mongodb://localhost:27017/geekcraft
cargo run --release
```

### Multi-Server Cluster
```bash
# All servers connect to the same MongoDB cluster
export GEEKCRAFT_DB_BACKEND=MONGODB
export MONGODB_URL=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/geekcraft?replicaSet=rs0
cargo run --release
```

---

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GEEKCRAFT_DB_BACKEND` | `INMEMORY` | Database backend: `MONGODB` or `INMEMORY` |
| `MONGODB_URL` | `mongodb://localhost:27017/geekcraft` | MongoDB connection URL |

---

## MongoDB Production Configuration

### Replica Set (High Availability)

```bash
# Start 3 MongoDB instances
mongod --replSet rs0 --port 27017 --dbpath /data/db1
mongod --replSet rs0 --port 27018 --dbpath /data/db2
mongod --replSet rs0 --port 27019 --dbpath /data/db3

# Initialize replica set
mongosh --port 27017
rs.initiate({
  _id: "rs0",
  members: [
    { _id: 0, host: "localhost:27017" },
    { _id: 1, host: "localhost:27018" },
    { _id: 2, host: "localhost:27019" }
  ]
})
```

### Sharding (Horizontal Scaling)

```bash
# Start config servers
mongod --configsvr --replSet configRS --port 27019 --dbpath /data/configdb

# Start shard servers
mongod --shardsvr --replSet shard1 --port 27018 --dbpath /data/shard1
mongod --shardsvr --replSet shard2 --port 27020 --dbpath /data/shard2

# Start mongos router
mongos --configdb configRS/localhost:27019 --port 27017
```

---

## Security Considerations

### All Backends
- Passwords are hashed with bcrypt (cost factor 12)
- Session tokens are cryptographically secure UUIDs
- Sessions auto-expire after 24 hours

### MongoDB-Specific
- Enable authentication:
  ```bash
  mongod --auth
  ```
- Create admin user:
  ```javascript
  use admin
  db.createUser({
    user: "admin",
    pwd: "secure_password",
    roles: ["userAdminAnyDatabase", "dbAdminAnyDatabase"]
  })
  ```
- Use TLS/SSL for network encryption:
  ```bash
  # In MongoDB connection string
  mongodb://localhost:27017/geekcraft?tls=true&tlsCertificateKeyFile=/path/to/cert.pem
  ```
- **Important**: Current implementation uses MongoDB driver v2.8 which has a known TLS certificate validation issue. For production with TLS, ensure proper certificate configuration or consider upgrading to driver v3.2.5+ (requires code migration).
- Configure firewall to restrict MongoDB port (27017)
- Enable audit logging for compliance

---

## Performance Tuning

### MongoDB

**Connection Pooling:**
```bash
# In MongoDB URL
mongodb://localhost:27017/geekcraft?maxPoolSize=100
```

**Indexes:**
```javascript
// Verify indexes are being used
db.sessions.find({ token: "..." }).explain("executionStats")
```

**Memory Configuration:**
```yaml
# In mongod.conf
storage:
  wiredTiger:
    engineConfig:
      cacheSizeGB: 4
```

---

## Monitoring

### MongoDB

```bash
# Monitor database statistics
mongosh --eval "db.serverStatus()"

# Check collection statistics
mongosh --eval "db.users.stats()"

# Monitor active operations
mongosh --eval "db.currentOp()"

# Check index usage
mongosh --eval "db.users.aggregate([{ $indexStats: {} }])"
```

---

## Backup and Restore

### MongoDB Backup

```bash
# Backup entire database
mongodump --db geekcraft --out /backup/geekcraft

# Backup specific collection
mongodump --db geekcraft --collection users --out /backup/users

# Restore database
mongorestore --db geekcraft /backup/geekcraft/geekcraft
```

---

## Migration from In-Memory to MongoDB

When switching from In-Memory to MongoDB, existing in-memory data is not migrated. Users will need to:

1. Register new accounts on the MongoDB backend
2. Re-submit their bot code
3. Rejoin active games

**Note:** This is intentional - In-Memory is designed for testing, not production data.

---

## Standalone Server Deployment Guide

This section covers setting up a standalone GeekCraft server with MongoDB from scratch.

### Step 1: Install MongoDB

Choose your platform:

#### Ubuntu/Debian (Recommended for Production)
```bash
# Import MongoDB public GPG key
curl -fsSL https://www.mongodb.org/static/pgp/server-7.0.asc | \
   sudo gpg -o /usr/share/keyrings/mongodb-server-7.0.gpg --dearmor

# Add MongoDB repository
echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | \
   sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list

# Install MongoDB
sudo apt-get update
sudo apt-get install -y mongodb-org

# Start MongoDB service
sudo systemctl start mongod
sudo systemctl enable mongod

# Verify MongoDB is running
sudo systemctl status mongod
```

#### macOS
```bash
# Install via Homebrew
brew tap mongodb/brew
brew install mongodb-community@7.0

# Start MongoDB as a service
brew services start mongodb-community@7.0

# Verify MongoDB is running
brew services list | grep mongodb
```

#### Docker (Alternative)
```bash
# Run MongoDB in a container with persistent storage
docker run -d \
  --name geekcraft-mongodb \
  -p 27017:27017 \
  -v mongodb_data:/data/db \
  -e MONGO_INITDB_ROOT_USERNAME=admin \
  -e MONGO_INITDB_ROOT_PASSWORD=yourSecurePassword \
  mongo:7.0

# Verify container is running
docker ps | grep geekcraft-mongodb
```

### Step 2: Initialize MongoDB Database

#### Option A: Automatic Initialization (Recommended)

GeekCraft will automatically create necessary collections and indexes when you first run it:

```bash
# Set environment variables
export GEEKCRAFT_DB_BACKEND=MONGODB
export MONGODB_URL=mongodb://localhost:27017/geekcraft

# Build GeekCraft
cd /path/to/GeekCraft
cargo build --release

# Start the server - database will be initialized automatically
./target/release/geekcraft
```

The server will automatically:
- Connect to MongoDB
- Create the `geekcraft` database if it doesn't exist
- Create required collections (`users`, `sessions`)
- Set up TTL indexes for session expiration

#### Option B: Manual Database Setup

If you want to manually initialize the database:

```bash
# Connect to MongoDB
mongosh

# Create the database
use geekcraft

# Create users collection with unique index
db.createCollection("users")
db.users.createIndex({ "username": 1 }, { unique: true })

# Create sessions collection with TTL index
db.createCollection("sessions")
db.sessions.createIndex({ "token": 1 })
db.sessions.createIndex({ "expires_at": 1 }, { expireAfterSeconds: 0 })

# Create counters collection for auto-incrementing IDs
db.createCollection("counters")
db.counters.insertOne({ "_id": "user_id", "value": 0 })

# Verify collections were created
db.getCollectionNames()

# Exit mongosh
exit
```

### Step 3: Configure MongoDB Authentication (Production)

For production deployments, enable authentication:

```bash
# Connect to MongoDB
mongosh

# Switch to admin database
use admin

# Create admin user
db.createUser({
  user: "geekcraft_admin",
  pwd: "YOUR_SECURE_PASSWORD_HERE",
  roles: [
    { role: "userAdminAnyDatabase", db: "admin" },
    { role: "dbAdminAnyDatabase", db: "admin" },
    { role: "readWriteAnyDatabase", db: "admin" }
  ]
})

# Create application user for GeekCraft
use geekcraft
db.createUser({
  user: "geekcraft_app",
  pwd: "YOUR_APP_PASSWORD_HERE",
  roles: [
    { role: "readWrite", db: "geekcraft" }
  ]
})

# Exit mongosh
exit
```

Enable authentication in MongoDB config:

```bash
# Edit MongoDB config file
sudo nano /etc/mongod.conf

# Add these lines under 'security' section:
security:
  authorization: enabled
```

Restart MongoDB:

```bash
sudo systemctl restart mongod
```

Update your GeekCraft connection string:

```bash
export MONGODB_URL="mongodb://geekcraft_app:YOUR_APP_PASSWORD_HERE@localhost:27017/geekcraft"
```

### Step 4: Populate Initial Data (Optional)

If you want to pre-populate the database with test users or initial data:

#### Create Test Users

```bash
# Start the GeekCraft server
export GEEKCRAFT_DB_BACKEND=MONGODB
export MONGODB_URL=mongodb://localhost:27017/geekcraft
./target/release/geekcraft

# In another terminal, register test users
curl -X POST http://localhost:3030/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser1", "password": "password123"}'

curl -X POST http://localhost:3030/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testuser2", "password": "password123"}'

# Generate zones for test users
curl -X POST http://localhost:3030/api/zone/generate \
  -H "Content-Type: application/json" \
  -d '{"player_id": "testuser1"}'

curl -X POST http://localhost:3030/api/zone/generate \
  -H "Content-Type: application/json" \
  -d '{"player_id": "testuser2"}'
```

#### Bulk Import Data (Advanced)

For bulk data import, create a JSON file:

```json
// test_users.json
[
  {
    "username": "alice",
    "password_hash": "$2b$12$KIXv4Q9Z8mN5yR2jP1kL6uJ3hB7wF8xY0sT5nE9dA4gC6fM2lO8pQ",
    "created_at": 1699564800
  },
  {
    "username": "bob",
    "password_hash": "$2b$12$LJYw5R0A9oO6zS3kQ2mM7vK4iC8xG9yZ1uU6oF0eB5hD7gN3mP9qR",
    "created_at": 1699564801
  }
]
```

Import using mongoimport:

```bash
mongoimport --db geekcraft --collection users --file test_users.json --jsonArray
```

**Warning:** Never import plain passwords! The example above shows pre-hashed passwords using bcrypt.

### Step 5: Verify Database Setup

```bash
# Connect to MongoDB
mongosh geekcraft

# Check collections
db.getCollectionNames()
# Should show: [ 'counters', 'sessions', 'users' ]

# Check indexes
db.users.getIndexes()
# Should include username unique index

db.sessions.getIndexes()
# Should include token and expires_at indexes

# Count users
db.users.countDocuments()

# Exit
exit
```

### Step 6: Start Production Server

```bash
# Set environment variables (add to systemd service or .bashrc)
export GEEKCRAFT_DB_BACKEND=MONGODB
export MONGODB_URL="mongodb://geekcraft_app:YOUR_APP_PASSWORD@localhost:27017/geekcraft"

# Start server
cd /path/to/GeekCraft
./target/release/geekcraft
```

### Step 7: Create Systemd Service (Linux Production)

Create a systemd service for automatic startup:

```bash
# Create service file
sudo nano /etc/systemd/system/geekcraft.service
```

Add this content:

```ini
[Unit]
Description=GeekCraft Game Server
After=network.target mongod.service
Requires=mongod.service

[Service]
Type=simple
User=geekcraft
WorkingDirectory=/opt/geekcraft
Environment="GEEKCRAFT_DB_BACKEND=MONGODB"
Environment="MONGODB_URL=mongodb://geekcraft_app:YOUR_PASSWORD@localhost:27017/geekcraft"
ExecStart=/opt/geekcraft/target/release/geekcraft
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

Enable and start the service:

```bash
# Reload systemd
sudo systemctl daemon-reload

# Enable service to start on boot
sudo systemctl enable geekcraft

# Start service
sudo systemctl start geekcraft

# Check status
sudo systemctl status geekcraft

# View logs
sudo journalctl -u geekcraft -f
```

### Step 8: Test the Deployment

```bash
# Health check
curl http://localhost:3030/api/health

# Register a user
curl -X POST http://localhost:3030/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "testplayer", "password": "testpass123"}'

# Login
curl -X POST http://localhost:3030/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "testplayer", "password": "testpass123"}'

# Generate a zone
curl -X POST http://localhost:3030/api/zone/generate \
  -H "Content-Type: application/json" \
  -d '{"player_id": "testplayer"}'

# List zones
curl http://localhost:3030/api/zones
```

---

## Troubleshooting Database Issues

### MongoDB Won't Start

```bash
# Check MongoDB logs
sudo tail -f /var/log/mongodb/mongod.log

# Check if port 27017 is in use
sudo netstat -tlnp | grep 27017

# Check MongoDB service status
sudo systemctl status mongod

# Restart MongoDB
sudo systemctl restart mongod
```

### GeekCraft Can't Connect to MongoDB

```bash
# Verify MongoDB is running
mongosh --eval "db.serverStatus()"

# Check connection string format
echo $MONGODB_URL

# Test connection manually
mongosh "$MONGODB_URL"

# Check firewall
sudo ufw status
sudo ufw allow 27017
```

### TTL Index Not Auto-Deleting Sessions

```bash
# Verify TTL index exists
mongosh geekcraft --eval "db.sessions.getIndexes()"

# Manually create TTL index
mongosh geekcraft --eval 'db.sessions.createIndex({"expires_at": 1}, {expireAfterSeconds: 0})'

# Check TTL monitor
mongosh --eval "db.serverStatus().metrics.ttl"
```

### Database Permissions Issues

```bash
# Verify user has correct permissions
mongosh geekcraft -u geekcraft_app -p

# List user permissions
use geekcraft
db.runCommand({usersInfo: "geekcraft_app", showPrivileges: true})
```

---

## Database Backup Strategy for Production

### Automated Daily Backups

Create a backup script:

```bash
# /opt/scripts/backup-geekcraft.sh
#!/bin/bash
BACKUP_DIR="/backup/geekcraft"
DATE=$(date +%Y%m%d_%H%M%S)

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Backup database
mongodump --db geekcraft --out "$BACKUP_DIR/$DATE"

# Compress backup
tar -czf "$BACKUP_DIR/geekcraft_$DATE.tar.gz" -C "$BACKUP_DIR" "$DATE"
rm -rf "$BACKUP_DIR/$DATE"

# Remove backups older than 30 days
find "$BACKUP_DIR" -name "geekcraft_*.tar.gz" -mtime +30 -delete

echo "Backup completed: $BACKUP_DIR/geekcraft_$DATE.tar.gz"
```

Add to crontab:

```bash
# Edit crontab
crontab -e

# Add daily backup at 2 AM
0 2 * * * /opt/scripts/backup-geekcraft.sh >> /var/log/geekcraft-backup.log 2>&1
```

### Restore from Backup

```bash
# Extract backup
cd /backup/geekcraft
tar -xzf geekcraft_20241103_020000.tar.gz

# Restore to MongoDB
mongorestore --db geekcraft geekcraft_20241103_020000/geekcraft

# Verify restoration
mongosh geekcraft --eval "db.users.countDocuments()"
```

---

## Support

For database-related questions:
- Check the logs when starting the server
- Ensure MongoDB is running (if using MongoDB backend)
- Verify environment variables are set correctly
- See examples in `/examples/auth_example.js`

---

## Future Enhancements

Planned MongoDB features:
- [ ] Code version history and rollback
- [ ] Advanced statistics and analytics
- [ ] Player achievements system
- [ ] Match replay storage and playback
- [ ] Global leaderboards
- [ ] Clan/team management
- [ ] In-game economy and trading
